<script type="text/javascript" src="lib/d3/v4/d3.js"></script>
<div class="graph"></div>
<div id="container"></div>
<div id="controls">
	<button type="button" id="btnReset" onclick="send('r')">Reset</button>
	<button type="button" id="btnLaunch" onclick="send('l')">Fallschirm LOS</button>
	<button type="button" id="btnX" onclick="send('x')">Lift Off</button>
</div>

<style>
body {
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

.graph .axis {
	stroke-width: 1;
}

.graph .axis .tick line {
	stroke: black;
}

.graph .axis .tick text {
	fill: black;
	font-size: 0.7em;
}

.graph .axis .domain {
	fill: none;
	stroke: black;
}

.graph .group {
	fill: none;
	stroke: black;
	stroke-width: 1.5;
}
</style>

<script type="text/javascript">
	var mock = false;

	function send(cmd) {
		connection.send("#" + cmd);
	};

	function mockdata() {
		dmock = [ {
			'time' : new Date(),
			//'Countdown': null,
			'Timer' : 9,
			'Fallschirm aktiv' : true,
			'Fallhoehe' : Math.random() * 10,
			'Alt' : 100 + (Math.random() - 0.5) * 10,
			'H' : (Math.random() - 0.5) * 10,
			'Ref Alt' : 100,
			'Max Alt' : 102 + (Math.random() - 0.5) * 10,
			'Altimeter' : true,
			'Flug' : false
		} ];
		processData(dmock, [ 'time', 'Countdown', 'Timer', 'Fallschirm aktiv',
				'Fallhoehe', 'Alt', 'H', 'Ref Alt', 'Max Alt', 'Altimeter',
				'Flug' ]);
	}

	if (!mock) {
		var connection = new WebSocket('ws://192.168.4.1:81', [ 'arduino' ]);
		connection.onopen = function() {
			connection.send('Connect ' + new Date());
		};
		connection.onerror = function(error) {
			console.log('WebSocket Error ', error);
		};

		connection.onmessage = function(e) {
			msg = JSON.parse(e.data);
			if (msg['status'] == 'event') {
				console.log(msg['message']);
			} else {
				processData(new Array(msg), [ 'time', 'Countdown', 'Timer',
						'Fallschirm aktiv', 'Fallhoehe', 'Alt', 'H', 'Ref Alt',
						'Max Alt', 'Altimeter', 'Flug' ]);
			}
		};
	} else {
		setInterval(mockdata, 500)
	}

	var startDate =0;

	var width = 800, height = 500

	var tbody;

	var t0 = -1;
	
	var groups = {
		'Fallhoehe' : {
			value : 0,
			color : 'orange',
			data : new Array()
		},
		'Alt' : {
			value : 0,
			color : 'green',
			data : new Array()

		},
		'Ref Alt' : {
			value : 0,
			color : 'blue',
			data : new Array()

		},
		'Max Alt' : {
			value : 0,
			color : 'black',
			data : new Array()
		},

		'H' : {
			value : 0,
			color : 'grey',
			data : new Array()
		}
	}
	var times = Array();

	var svg = d3.select('.graph').append('svg').attr('class', 'chart').attr(
			'width', width).attr('height', height + 50);

	var margin = {
		top : 0,
		right : 0,
		bottom : 20,
		left : 40
	}, width = +svg.attr("width") - margin.left - margin.right, height = +svg
			.attr("height")
			- margin.top - margin.bottom;

	var x = d3.scaleLinear().domain([ 0, 10000 ]).range(
			[ margin.left, width - margin.left ])
	var y = d3.scaleLinear().domain([ -1, 3 ]).range([ height, 0 ])

	var line = d3.line().curve(d3.curveBasis).x(function(d) {
		return x(d[1])
	}).y(function(d) {
		return y(d[0])
	})
	g = svg.append("g");

	axis = g.append("g").attr("class", "axis axis--x").attr("transform",
			"translate(0," + height + ")").call(d3.axisBottom(x));

	g.append("g").attr("class", "axis axis--y").attr("transform",
			"translate(" + margin.left + "," + margin.top + ")").call(
			d3.axisLeft(y));

	var paths = svg.append('g')

	for ( var name in groups) {
		var group = groups[name]
		group.path = paths.append('path').data([ group.data ]).attr('class',
				name + ' group').style('stroke', group.color)
	}

	function processData(data) {
		tabulate(data, [ 'time', 'Countdown', 'Timer', 'Fallschirm aktiv',
				'Fallhoehe', 'Alt', 'H', 'Ref Alt', 'Max Alt', 'Altimeter',
				'Flug' ]);
		addChartData(data)
	}

	function addChartData(data) {
	
		// Add new values
		var time = 0;
		for (val in data) {
			for ( var name in groups) {
				var group = groups[name];
				//group.data.push(group.value) // Real values arrive at irregular intervals
				group.data.push([ data[val][name], data[val].time ]);
				group.path.attr('d', line);
				if( data[val].time > time ) time = data[val].time;
			}
		}
		if( t0 < 0 ) t0 = time; 
			
		// Shift domain
		//x.domain([ now - (limit - 2) * duration, now - duration ])
		x.domain([t0, time + 2000])

		// Slide x-axis left
		axis.call(d3.axisBottom(x));

		// Slide paths left
		/*paths.attr('transform', null).attr(
				'transform',
				'translate(' + x(now - (limit - 1) * duration) + ')');
		 */
		// Remove oldest data point from each group
		for ( var name in groups) {
			var group = groups[name]
			//group.data.shift()
		}
	}

	function tabulate(data, columns) {
		d3.select("#container").selectAll("*").remove();
		var table = d3.select("#container").append("table"), thead = table
				.append("thead");
		tbody = table.append("tbody");

		// append the header row
		thead.append("tr").selectAll("th").data(columns).enter().append("th")
				.text(function(column) {
					return column;
				});

		// create a row for each object in the data
		var rows = tbody.selectAll("tr").data(data).enter().append("tr");

		// create a cell in each row for each column
		var cells = rows.selectAll("td").data(function(row) {
			return columns.map(function(column) {
				return {
					column : column,
					value : row[column]
				};
			});
		}).enter().append("td").text(function(d) {
			return d.value;
		});

		return table;
	}
</script>